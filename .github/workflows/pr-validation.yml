name: PR Validation
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-checklist:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate PR Checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            let checklist = '## âœ… Automated PR Checklist\n\n';

            // Check PR description
            const hasDescription = pr.body && pr.body.length > 50;
            checklist += hasDescription ? 'âœ… ' : 'âŒ ';
            checklist += 'PR has detailed description\n';
            
            // Check for issue reference
            const hasIssueRef = pr.body && /#\d+/.test(pr.body);
            checklist += hasIssueRef ? 'âœ… ' : 'âš ï¸ ';
            checklist += 'References related issue\n';
            
            // Check for tests
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const hasTests = files.some(f => f.filename.includes('test'));
            checklist += hasTests ? 'âœ… ' : 'âš ï¸ ';
            checklist += 'Includes test changes\n';
            
            // Manual checklist reminder
            checklist += '\n### ðŸ“‹ Manual Checklist\n';
            checklist += 'Please ensure:\n';
            checklist += '- [ ] Tests pass locally\n';
            checklist += '- [ ] Code follows project conventions\n';
            checklist += '- [ ] Documentation updated if needed\n';
            checklist += '- [ ] No sensitive data exposed\n';
            
            // Find or update checklist comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const checklistComment = comments.data.find(c => 
              c.user.type === 'Bot' && c.body.includes('Automated PR Checklist')
            );
            
            if (checklistComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: checklistComment.id,
                body: checklist
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: checklist
              });
            }